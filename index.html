<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>_</title>
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
</head>
<body>
    <div style="position: absolute; width: 100%;">
        <progress id="progress-bar" value="32" max="100" style="position: absolute; left: 35%; width: 30%; margin-top: 5%;"></progress>
    </div>
    <div id="toolbar" style="display: none;">
        <div style="background-color: #222;width: 9vw; border-right: 1px solid white; border-bottom: 1px solid white; border-bottom-right-radius: 10px;">
            <button id="zoominbutton" type="button" onclick="zoomIn()">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                </svg>
            </button>
            <button id="zoomoutbutton" type="button" onclick="zoomOut()">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                    <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM13 10H7" />
                </svg>
            </button>
        </div>
    </div>
    <div id="scene">
    </div>
    <!-- <div style="position: absolute; top: 0; bottom: 0; left: 0; right: 0; width: 100%; height: 100%; align-items: center;"> -->
    <!-- </div> -->
    <style>
        body {
            margin: 0;
        }
        canvas {
            display: block;
            margin-left: auto;
            margin-right: auto;
            margin-top: 4px;
            margin-bottom: 4px;
            border: 1px solid gray;
        }
        div#scene {
            display: block;
            background-color: #343A40;
            height: 100vh;
            overflow-y: scroll;
        }
        input {
            display: block;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(2);
        }
        button {
            /* background-color: rgba(0, 0, 0, 0.15); */
            /* color: rgba(0, 0, 0, 0.3); */
            width: 5em;
            height: 5em;
            margin-left: 1em;
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            border: none;
            border-radius: 10%;
        }
    </style>

    <script>
        let thePdf;
        let scale = 4;
        let zoom=0.75
        const scene = document.getElementById('scene');
        const input = document.getElementById('file');

        let sceneWidth = scene.clientWidth;

        new ResizeObserver((x) => {
            if (sceneWidth === scene.clientWidth) {
                return;
            }
            sceneWidth = scene.clientWidth;
            repaint(scene);
            repaint(scene, thePdf);
        }).observe(scene);

        async function repaint(scene, pdf) {
            if (!pdf) {
                while(scene.firstChild) {
                    scene.removeChild(scene.firstChild);
                }
                return;
            }
            let elem=document.getElementById('toolbar')
            elem=elem.cloneNode(true)
            elem.style.display='block'
            scene.innerHTML=elem.innerHTML

            for (let i = 0; i < pdf.numPages; i++) {
                const page = await pdf.getPage(i + 1);
                const viewport = page.getViewport({ scale });
                const canvas = document.createElement('canvas');

                canvas.height = viewport.height;
                canvas.width = viewport.width;
                const aspect = viewport.width / viewport.height;

                canvas.style.height = `${(sceneWidth / aspect - 8)*zoom}px`;
                canvas.style.width = `${(sceneWidth - 8)*zoom}px`;
                canvas.style.backgroundColor = '#ccc';

                scene.appendChild(canvas);

                const observer = new IntersectionObserver(events => {
                    if (events[0].isIntersecting) {
                        page.render({
                            canvasContext: canvas.getContext('2d'),
                            viewport,
                        });
                        observer.disconnect();
                    }
                }, {
                    root: scene,
                    rootMargin: '0px',
                    threshold: 0,
                });
                observer.observe(canvas);
            }
        }

        const progressBar=document.getElementById("progress-bar")
        var url = new URL(window.location.href);
	    var c = url.searchParams.get("url");
        
        url = c || 'https://www.antennahouse.com/hubfs/xsl-fo-sample/pdf/basic-link-1.pdf?hsLang=en';

        async function openURL(url) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            // The workerSrc property shall be specified.
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js';
            // pdfjsLib.getDocument(url,undefined,undefined,progressCallback)
            var loadingTask = pdfjsLib.getDocument(url);
            //get progress data
            progressBar.style.display="block"
            loadingTask.onProgress = function(data){
                progressBar.value=data.loaded*100/data.total;
            }
            //use document
            loadingTask.promise.then( function (pdf){
                progressBar.style.display="none"
                thePdf = pdf;
                repaint(scene);  // clear previous pdf if any
                repaint(scene, thePdf);  // render new pdf
            })
        };

        openURL(url)

        function openFile(event) {
            const input = event.target;

            const reader = new FileReader();
            reader.onload = async function () {
                const pdfjsLib = window['pdfjs-dist/build/pdf'];

                // The workerSrc property shall be specified.
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://mozilla.github.io/pdf.js/build/pdf.worker.js';

                thePdf = await pdfjsLib.getDocument({
                    data: reader.result,
                }).promise;

                repaint(scene);  // clear previous pdf if any
                repaint(scene, thePdf);  // render new pdf
                input.style.display = 'none';
            };
            reader.readAsArrayBuffer(input.files[0]);
        };

        function scrollDown() {
            const sh = scene.clientHeight;
            const st = scene.scrollTop;

            scene.scroll({
                top: st + 0.5 * sh,
                behavior: 'smooth',
            });
        }

        function scrollUp() {
            const sh = scene.clientHeight;
            const st = scene.scrollTop;

            scene.scroll({
                top: st - 0.5 * sh,
                behavior: 'smooth',
            });
        }

        function closeFile() {
            thePdf = undefined;
            repaint(scene);
            input.style.display = 'block';
            input.value = null;
        }

        function zoomIn(){
            zoom = zoom + 0.25;
            repaint(scene);  // clear previous pdf if any            
            repaint(scene, thePdf);
        }
        function zoomOut(){
            if (zoom <= 0.25) {
              return;
           }
           zoom = zoom - 0.25;
           repaint(scene);  // clear previous pdf if any
           repaint(scene, thePdf);
        }
        //END: Custom methods


        document.addEventListener('keydown', event => {
            if (event.code === 'PageDown') {
                event.preventDefault();
                scrollDown();
            } else if (event.code === 'PageUp') {
                event.preventDefault();
                scrollUp();
            }
        });
    </script>
</body>

</html>

<!-- <input id="file" type='file' accept='application/pdf' onchange='openFile(event)'> -->
    <!-- <button id="down" onclick="scrollDown()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z"
                clip-rule="evenodd" />
        </svg>
    </button>
    <button id="clear" onclick="closeFile()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd" />
        </svg>
    </button> -->
    <!-- <button id="up" onclick="scrollUp()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z"
                clip-rule="evenodd" />
        </svg>
    </button> -->


    <!-- button#down {
        right: 10px;
        bottom: 10px;
    }
    button#up {
        right: 10px;
        top: 10px;
    }
    button#clear {
        right: 10px;
        top: calc(50% - 2em);
    }
    button {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.15);
        color: rgba(0, 0, 0, 0.3);
        width: 4em;
        height: 4em;
        padding: 0;
        border: none;
        border-radius: 50%;
    } -->
